<jqa:jqassistant-rules xmlns:jqa="http://www.buschmais.com/jqassistant/core/analysis/rules/schema/v1.0">

    <group id="jqa-legal">
        <!--
         ! For details see
         ! https://github.com/buschmais/jqa-own-constraints/issues/4.
         ! Oliver B. Fischer, 2017-05-21
         !-->
        <!--includeConstraint refId="jqa-legal:license:exists"/-->
        <includeConstraint refId="jqa-legal:license:only-one-in-pom"/>
        <includeConstraint refId="jqa-legal:license:is-correctly-defined"/>
    </group>



    <constraint id="jqa-legal:license:exists" severity="minor">
        <description><![CDATA[
            It must exist in the root directory of the project a
            readme file called 'LICENSE'.

            This file contains the license of the project
            and should help users to identify the type of license
            the project uses.
            ]]></description>
        <cypher><![CDATA[
            MATCH
                (license:File)

            WHERE
                license.fileName =~ '/LICENSE'

            RETURN
                CASE count(license)
                    WHEN 1 THEN 0
                    ELSE 1
                END AS missing
        ]]></cypher>
        <verify>
            <aggregation column="missing"/>
        </verify>
    </constraint>


    <!--
     ! Rules temporaly copied from license.xml
     !-->

    <constraint id="jqa-legal:license:only-one-in-pom" severity="minor">
        <description><![CDATA[
A jQAssistant project must have exactly one license specified in
its Maven POM. This project has one or more then one license
specified.
            ]]></description>
        <cypher><![CDATA[

        MATCH (n:Project:Directory:Maven)-[HAS_MODEL]
                ->(m:Maven:Pom)
                -[USES_LICENSE]->(l:License:Maven)

        WHERE NOT((n)-[:HAS_EFFECTIVE_MODEL]->(m))

        RETURN
                CASE count(l)
                    WHEN 1 THEN 0
                    WHEN 0 THEN 1
                    ELSE count(l)
                END AS existing
        ]]></cypher>
        <verify>
            <aggregation column="existing"/>
        </verify>
    </constraint>


    <constraint id="jqa-legal:license:is-correctly-defined">
        <description><![CDATA[
The license definition seems to be wrong. Please ensure
to declare the license in this project as follows:

    <licenses>
        <license>
            <name>GNU General Public License, v3</name>
            <url>http://www.gnu.org/licenses/gpl-3.0.html</url>
        </license>
    </licenses>

            ]]></description>
        <cypher><![CDATA[
            MATCH (n:Project:Directory:Maven)
                    -[HAS_MODEL]->(m:Maven:Pom)
                    -[USES_LICENSE]->(l:License:Maven)

            WHERE NOT((n)-[:HAS_EFFECTIVE_MODEL]->(m))

            WITH l

            MATCH (l {name: "GNU General Public License, v3",
                      url:"http://www.gnu.org/licenses/gpl-3.0.html"})

            RETURN
                CASE count(l)
                    WHEN 0 THEN 1
                    ELSE 0
                END AS existing
        ]]></cypher>
        <verify>
            <aggregation column="existing"/>
        </verify>
    </constraint>


</jqa:jqassistant-rules>
